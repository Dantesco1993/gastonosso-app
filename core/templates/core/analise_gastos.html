{% extends 'core/base.html' %}
{% load humanize %}

{% block title %}Análise Financeira{% endblock %}

{% block content %}

{% if not familia %}
    {# Se o usuário não tem família, mostra uma mensagem de ajuda #}
    <div class="alert alert-warning text-center" role="alert">
        <h4 class="alert-heading">Configure sua Família!</h4>
        <p>Você precisa criar ou entrar em uma família para poder usar as ferramentas de análise financeira.</p>
        <hr>
        <a href="{% url 'gerenciar_familia' %}" class="btn btn-primary">Clique aqui para configurar sua família</a>
    </div>
{% else %}
    {# Se o usuário já tem família, mostra o conteúdo normal da página #}

    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h1>Análise Financeira <small class="text-muted fs-5">({{ data_inicio|date:"d/m/y" }} a {{ data_fim|date:"d/m/y" }})</small></h1>
        <div class="d-flex gap-2">
            {% include 'core/partials/periodo_seletor.html' %}
            {% include 'core/partials/visao_seletor.html' %}
        </div>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <form method="GET" action="{% url 'analise_gastos' %}">
                <div class="row g-3 align-items-end">
                    <div class="col-md">
                        <label for="data_inicio" class="form-label">Data de Início</label>
                        <input type="date" class="form-control" name="data_inicio" value="{{ data_inicio|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md">
                        <label for="data_fim" class="form-label">Data de Fim</label>
                        <input type="date" class="form-control" name="data_fim" value="{{ data_fim|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md">
                        <label for="agrupamento" class="form-label">Agrupar por:</label>
                        <select name="agrupamento" class="form-select">
                            <option value="mensal" {% if agrupamento == 'mensal' %}selected{% endif %}>Mês</option>
                            <option value="semanal" {% if agrupamento == 'semanal' %}selected{% endif %}>Semana</option>
                            <option value="diario" {% if agrupamento == 'diario' %}selected{% endif %}>Dia</option>
                        </select>
                    </div>
                    <input type="hidden" name="visao" value="{{ visao }}">
                    <input type="hidden" name="periodo" value="{{ periodo }}">
                    <div class="col-md-auto">
                        <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header">
                    <h5>Gastos por Categoria Principal</h5>
                </div>
                <div class="card-body d-flex align-items-center justify-content-center">
                    {% if data_pie %}
                        <canvas id="gastosPorCategoriaChart"></canvas>
                    {% else %}
                        <p class="text-muted m-0">Sem gastos no período para exibir no gráfico.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div id="drilldown-container">
                <div class="card h-100 shadow-sm">
                    <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
                        <i class="bi bi-graph-up" style="font-size: 4rem; color: #6c757d;"></i>
                        <h5 class="mt-3">Detalhes da Categoria</h5>
                        <p class="text-muted">Clique em uma fatia do gráfico à esquerda para ver os detalhes das subcategorias aqui.</p>
                    </div>
                </div>
            </div>
            <button id="htmx-drilldown-trigger"
                    hx-get="{% url 'analise_drilldown_categoria' %}"
                    hx-target="#drilldown-container"
                    hx-swap="innerHTML"
                    class="d-none">
            </button>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5>Evolução de Receitas vs. Despesas</h5>
                </div>
                <div class="card-body">
                    <canvas id="fluxoCaixaChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- GRÁFICO DE PIZZA (GASTOS POR CATEGORIA) ---
        const labelsPie = {{ labels_pie|safe }};
        const dataPie = {{ data_pie|safe }};
        
        if (dataPie.length > 0) {
            const ctxPie = document.getElementById('gastosPorCategoriaChart');
            let chartStatusPie = Chart.getChart("gastosPorCategoriaChart");
            if (chartStatusPie != undefined) { chartStatusPie.destroy(); }

            const pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: { labels: labelsPie, datasets: [{
                        label: 'Gastos', data: dataPie,
                        backgroundColor: ['#0d6efd', '#6c757d', '#198754', '#dc3545', '#ffc107', '#0dcaf0', '#6f42c1'],
                        borderColor: 'rgba(255, 255, 255, 1)', borderWidth: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (event, elements) => {
                        const chart = event.chart;
                        if (elements.length > 0) {
                            const clickedIndex = elements[0].index;
                            const categoriaNome = chart.data.labels[clickedIndex];
                            const urlParams = new URLSearchParams(window.location.search);
                            const visao = urlParams.get('visao') || 'individual';
                            const data_inicio = '{{ data_inicio|date:"Y-m-d" }}';
                            const data_fim = '{{ data_fim|date:"Y-m-d" }}';
                            const htmxUrl = `{% url 'analise_drilldown_categoria' %}?categoria_mae=${encodeURIComponent(categoriaNome)}&visao=${visao}&data_inicio=${data_inicio}&data_fim=${data_fim}`;
                            const trigger = document.getElementById('htmx-drilldown-trigger');
                            trigger.setAttribute('hx-get', htmxUrl);
                            htmx.process(trigger);
                            trigger.click();
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    plugins: { legend: { position: 'top' }, title: { display: false } }
                }
            });
        }

        // --- GRÁFICO DE BARRAS (FLUXO DE CAIXA MENSAL) ---
        const labelsBar = {{ labels_bar|safe }};
        const dataReceitasBar = {{ data_receitas_bar|safe }};
        const dataDespesasBar = {{ data_despesas_bar|safe }};
        const ctxBar = document.getElementById('fluxoCaixaChart');
        
        let chartStatusBar = Chart.getChart("fluxoCaixaChart");
        if (chartStatusBar != undefined) { chartStatusBar.destroy(); }

        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: labelsBar,
                datasets: [
                    {
                        label: 'Receitas', data: dataReceitasBar,
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1
                    },
                    {
                        label: 'Despesas (Caixa)', data: dataDespesasBar,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { position: 'top' } }
            }
        });
    </script>

{% endif %}
{% endblock %}