{% extends 'core/base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ investimento.nome }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ investimento.nome }}</h1>
    <a href="{% url 'lista_investimentos' %}" class="btn btn-secondary">Voltar</a>
</div>
        
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 text-center">
                <h5>Valor de Mercado Atual</h5>
                <p class="display-6 text-success fw-bold">R$ {{ investimento.valor_atual|floatformat:2 }}</p>
            </div>
            <div class="col-md-4 text-center">
                <h5>Tipo</h5>
                <p class="lead">{{ investimento.get_tipo_display }}</p>
            </div>
            <div class="col-md-4 text-center">
                <h5>Rendimento Anual (Estimado)</h5>
                <p class="lead">{{ investimento.taxa_rendimento_anual }}%</p>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header">
        <i class="bi bi-graph-up-arrow"></i> Projeção de Rendimentos (Juros Compostos)
    </div>
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label for="anosInput" class="form-label">Projetar por (anos):</label>
                <input type="number" class="form-control" id="anosInput" value="10" min="1">
            </div>
            <div class="col-md-8 text-center text-md-start mt-3 mt-md-0">
                <h5>Valor Projetado:</h5>
                <h2 class="display-5 fw-bold text-primary" id="resultadoProjecao">R$ 0,00</h2>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4 mb-4">
        <h2 class="h4">Fazer Novo Aporte</h2>
        <div class="card">
            <div class="card-body">
                <form method="POST" action="{% url 'adicionar_aporte_investimento' investimento.id %}">
                    {% csrf_token %}
                    {{ form_aporte|crispy }}
                    <button type="submit" class="btn btn-success w-100 mt-3">Aportar Valor</button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h2 class="h4">Histórico de Aportes</h2>
            {% include 'core/partials/visao_seletor.html' %}
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr><th>Data</th><th>Valor</th><th>Conta de Origem</th><th>Autor</th></tr>
                </thead>
                <tbody>
                    {% for aporte in aportes %}
                    <tr>
                        <td>{{ aporte.data|date:"d/m/Y" }}</td>
                        <td class="text-success">+ R$ {{ aporte.valor|floatformat:2 }}</td>
                        <td>{{ aporte.conta_origem.nome }}</td>
                        <td>{{ aporte.user.username }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center p-4">Nenhum aporte registrado para a visão selecionada.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const anosInput = document.getElementById('anosInput');
    const resultadoSpan = document.getElementById('resultadoProjecao');

    const valorInicial = parseFloat("{{ investimento.valor_atual|stringformat:'f' }}".replace(',', '.'));
    const taxaAnual = parseFloat("{{ investimento.taxa_rendimento_anual|stringformat:'f' }}".replace(',', '.')) / 100;

    function calcularProjecao() {
        const anos = parseInt(anosInput.value) || 0;

        if (anos >= 1 && valorInicial > 0 && taxaAnual > 0) {
            const valorFinal = valorInicial * Math.pow((1 + taxaAnual), anos);
            resultadoSpan.textContent = valorFinal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        } else {
            resultadoSpan.textContent = valorInicial.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
    }

    anosInput.addEventListener('input', calcularProjecao);
    document.addEventListener('DOMContentLoaded', calcularProjecao);
</script>
{% endblock %}